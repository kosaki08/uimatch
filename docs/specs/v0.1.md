# uiMatch v0.1

**Status**: Draft  
**Audience**: Developers integrating design-to-implementation checks  
**Scope**: Minimal viable implementation for single-viewport, component-level comparison

## 1. Purpose

uiMatch evaluates how closely an implemented UI matches a Figma design and returns concise, actionable hints to fix the gaps. It is distributed as a Claude Code plugin that provides `/uiMatch` commands backed by an in-process TypeScript library.

## 2. Non-Goals (MVP)

- Multiple viewports or themes
- Animated or non-deterministic rendering
- React tree/semantics diff
- Automatic code changes (only suggestions/hints are produced)

## 3. High-Level Architecture

```
Claude Code → uiMatch Plugin (.claude-plugin/)
              ├─ Commands (compare, loop, settings)
              └─ uimatch-core library
                  ├─ Figma MCP: fetch frame PNG + variables
                  └─ Playwright: capture screenshot + styles
```

- All calls are in-process; **no child_process** and **no persistent report files**.
- Artifacts (e.g., diff image) are returned as base64 only when explicitly requested.
- MCP integration defined in `mcp.json` for Figma API access.

## 4. Inputs and Outputs

### 4.1 Compare Input

- **Design source**: Figma `fileKey` + `nodeId` (+ optional `pngScale`)
- **Target implementation**: `url`, `selector`, `viewport {width, height}`, `dpr`
- **Options** (all optional):
  - `thresholds`: `{ pixelDiffRatio, deltaE }`
  - `ignore`: list of CSS properties to exclude from style comparison
  - `weights`: relative importance for categories (`color`, `spacing`, `radius`, `border`, `shadow`, `typography`)
  - `tokens`: mapping between Figma variables and CSS variables (color/font/spacing)
  - `emitArtifacts`: whether to return base64 images
  - `font.preloadUrls`: list of font URLs to preload before capture
  - `basicAuth`: `{ username, password }` for protected targets

### 4.2 Diff Report (Output)

```ts
type DiffReport = {
  metrics: {
    pixelDiffRatio: number; // 0..1
    colorDeltaEAvg: number; // CIEDE2000 average on compared colors
    dfs: number; // 0..100 Design Fidelity Score (derived from metrics)
  };
  styleDiffs: Array<{
    path: string; // logical path, e.g., "Card > Heading"
    selector: string; // CSS selector or marker (e.g., [data-testid="..."])
    properties: Record<
      string,
      { actual?: string; expected?: string; expectedToken?: string; delta?: number; unit?: string }
    >;
    severity: 'low' | 'medium' | 'high';
    patchHints?: Array<{ file: string; line?: number; suggest: string }>;
  }>;
  artifacts?: {
    figmaPngB64?: string;
    implPngB64?: string;
    diffPngB64?: string;
  };
};
```

- `dfs` (Design Fidelity Score) is a normalized summary derived from pixel and color differences and the presence of high-severity style diffs.

## 5. Processing Steps

1. **Design fetch**: Retrieve Figma frame PNG (and variables when available) via Figma API or MCP.
2. **Target capture**: Use Playwright (Chromium) to load the target URL, wait for network idle, preload fonts, disable animations, then:
   - capture PNG of the target element (`selector`)
   - collect computed styles for the element and a bounded set of key descendants

3. **Image diff**: Compute pixel difference ratio using `pixelmatch` (with AA/threshold tuned for UI).
4. **Style diff**: Compare selected CSS properties (e.g., font-size/line-height/weight, color (ΔE2000), border-radius, shadow, border, gap, padding, basic flex layout).
5. **Report**: Aggregate metrics, rank diffs by severity, and attach optional artifacts as base64.

## 6. Plugin Commands

- **`/uiMatch compare figma=<url|fileKey:nodeId> story=<url> selector=<css> [opts]`**
  Returns: `DiffReport` + a short summary (DFS and top diffs). Optional base64 artifacts if requested.
- **`/uiMatch loop ...`**
  Executes repeated compare cycles up to `maxIters` or until thresholds are satisfied. Produces the latest `DiffReport` and a per-iteration summary.
- **`/uiMatch settings`**
  Read and update thresholds, ignore list, weights, and font preload settings.

## 7. Configuration (Examples)

- **Thresholds**: default `pixelDiffRatio=0.03`, `deltaE=3.0`
- **Ignore list**: e.g., `["font-family", "font-kerning"]`
- **Weights**: optional emphasis per category, e.g., `{ "color": 1.0, "spacing": 1.2 }`
- **Font preload**: list of WOFF/WOFF2 URLs injected before capture to reduce rendering variance

## 8. Quality Gates (Loop)

- **Pass**: `pixelDiffRatio ≤ T1` **and** `colorDeltaEAvg ≤ T2` **and** no `high` severity diffs
- **Stop conditions**: `maxIters` reached or improvement below a small threshold between iterations

## 9. Error Handling (Summary)

- **Figma rate limits**: exponential backoff; reuse recent design PNG when appropriate
- **Target timeouts**: fall back to stricter waits (`networkidle`, `requestIdleCallback`)
- **Fonts not loaded**: warn and suggest preloading; keep style diffs but mark uncertain color results
- **Selector mismatch**: return a clear error with guidance to verify `selector` or `data-testid`

## 10. Security & Privacy

- Secrets (e.g., Figma tokens, basic auth) are provided via environment variables and are not logged.
- No persistent output files by default. Artifacts are in-memory and only returned when explicitly requested.
- All processing is local to the environment where the plugin runs.

## 11. Packaging

```
.claude-plugin/
├── plugin.json              # Metadata (name, version, commands)
├── commands/
│   ├── compare.md           # /uiMatch compare implementation
│   ├── loop.md              # /uiMatch loop implementation
│   └── settings.md          # /uiMatch settings implementation
├── mcp.json                 # Figma MCP server integration
└── marketplace.json         # Distribution metadata

packages/
├── uimatch-core/            # Core comparison library
└── uimatch-plugin/          # Plugin integration code
```

**Distribution**: Published via GitHub repository + Claude Code Plugin Marketplace.

## 12. Dependencies (MVP)

- Playwright (Chromium) for capture, pixelmatch for image diff, PNG decode/encode, and a ΔE2000 implementation for color difference
